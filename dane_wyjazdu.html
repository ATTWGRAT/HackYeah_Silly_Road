<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Silly road - Dane wyjazdu</title>
    <style>
        body { margin: 0; height: 100vh; background: #f7c564; font-family: Arial, sans-serif; }
        .container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff3d1; border-radius: 12px; border: 2px solid #5a2a0e; box-shadow: 0 8px 18px rgba(0,0,0,0.12); padding: 32px 24px; display: flex; flex-direction: column; align-items: center; gap: 18px; }
        .text-input { padding: 12px 32px; font-size: 22px; color: #863e15; background: #f7c564; border-radius: 4px; border: 2px solid #5a2a0e; font-weight: bold; box-shadow: 0 6px 12px rgba(0,0,0,0.08); outline: none; width: 220px; text-align: center; }
        .button { padding: 12px 32px; font-size: 22px; color: #f2cf0d; background: #863e15; border-radius: 4px; border: 2px solid #5a2a0e; font-weight: bold; box-shadow: 0 8px 18px rgba(0,0,0,0.12); cursor: pointer; }
        .button:hover { background: #5a2a0e; }
        .step-label { font-size: 22px; color: #5a2a0e; font-weight: bold; margin-bottom: 8px; }
        #searchSidebar {
            position: fixed;
            top: 0;
            right: -34vw;
            width: 33vw;
            min-width: 320px;
            max-width: 480px;
            height: 100vh;
            background: #fff3d1;
            border-left: 3px solid #5a2a0e;
            box-shadow: -8px 0 24px rgba(0,0,0,0.13);
            z-index: 1000;
            transition: right 0.4s cubic-bezier(.77,0,.18,1);
            display: flex;
            flex-direction: column;
        }
        #searchSidebar.open {
            right: 0;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 18px;
            font-size: 2.1rem;
            font-weight: bold;
            color: #863e15;
            background: #ffe6a7;
            padding: 24px 24px 16px 24px;
            border-bottom: 2px solid #f2cf0d;
        }
        .sidebar-emoji {
            font-size: 2.5rem;
        }
        .sidebar-country {
            font-size: 1.5rem;
            color: #5a2a0e;
            font-weight: bold;
        }
        .sidebar-city {
            font-size: 1.5rem;
            color: #863e15;
            font-weight: bold;
            margin-left: 10px;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 18px 24px 24px 24px;
        }
        #sidebarToggle {
            position: absolute;
            left: -36px;
            top: 32px;
            width: 32px;
            height: 48px;
            background: #863e15;
            color: #f2cf0d;
            border: 2px solid #5a2a0e;
            border-radius: 8px 0 0 8px;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1001;
            transition: left 0.4s cubic-bezier(.77,0,.18,1);
        }
        #searchSidebar.open #sidebarToggle {
            left: -36px;
        }
        .category-box {
            background: #f7c564;
            color: #863e15;
            border: 2px solid #f2cf0d;
            border-radius: 8px;
            padding: 6px 16px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 2px;
            transition: background 0.2s, color 0.2s;
            user-select: none;
        }
        .category-box:hover, .category-box.selected {
            background: #f2cf0d;
            color: #5a2a0e;
        }
        .search-result-box {
            background: #fffbe6;
            color: #5a2a0e;
            border: 2px solid #f2cf0d;
            border-radius: 8px;
            padding: 12px 18px;
            font-size: 1.08rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
        }
        .search-result-box:hover {
            background: #f7c564;
            color: #863e15;
        }
        @media (max-width: 900px) {
            #searchSidebar { width: 90vw; min-width: 0; }
        }
        .sidebar-searchbar {
            padding: 0 24px 12px 24px;
            background: #fff3d1;
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
        }
        .sidebar-searchbar input {
            width: 100%;
            padding: 10px 16px;
            font-size: 1.1rem;
            border-radius: 6px;
            border: 2px solid #f2cf0d;
            outline: none;
            box-sizing: border-box;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container" id="stepContainer">
        <!-- Dynamiczne pola krok po kroku -->
    </div>
    <!-- WYSUWANE OKNO WYSZUKIWANIA -->
    <div id="searchSidebar">
        <div class="sidebar-header">
            <span class="sidebar-emoji">üîç</span>
            <span class="sidebar-country" id="sidebarCountry"></span>
            <span class="sidebar-city" id="sidebarCity"></span>
        </div>
        <div class="sidebar-searchbar">
            <input id="sidebarSearchInput" type="text" placeholder="Wyszukaj...">
        </div>
        <div class="sidebar-content">
            <div id="categoriesList" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px;"></div>
            <div id="searchResults" style="margin-top:12px;display:flex;flex-direction:column;gap:10px;align-items:flex-start;"></div>
            <!-- Tu mo≈ºna dodaƒá pole wyszukiwania lub wyniki -->
        </div>
        <button id="sidebarToggle">&lt;</button>
    </div>
    <script>
        let lobby = null;
        try {
            lobby = JSON.parse(sessionStorage.getItem('currentLobby'));
        } catch {}
        let code = lobby ? lobby.code : '';
        // Wylicz liczbƒô dni na podstawie beginning i end
        let beginning = lobby ? lobby.beginning : sessionStorage.getItem('lobbyBeginning');
        let end = lobby ? lobby.end : sessionStorage.getItem('lobbyEnd');
        let length = 2;
        let errorMsg = '';
        if (!beginning || !end) {
            errorMsg = 'Brak danych o dacie wyjazdu. Wr√≥ƒá do tworzenia lobby.';
        } else {
            const beginDate = new Date(beginning);
            const endDate = new Date(end);
            const diff = Math.floor((endDate - beginDate) / (1000 * 60 * 60 * 24));
            if (isNaN(diff) || diff < 1) {
                errorMsg = 'Daty wyjazdu sƒÖ nieprawid≈Çowe. Wr√≥ƒá do tworzenia lobby.';
            } else {
                length = diff + 1;
            }
        }
        sessionStorage.setItem('lobbyLength', length);
        let budget = parseFloat(lobby ? lobby.budget : sessionStorage.getItem('lobbyBudget'));
        if (isNaN(budget)) budget = 0;
        const attractionsCount = 2 + (length - 2) * 3;
        const steps = [
            { key: 'miejscowosc', label: 'Miejscowo≈õƒá' },
            { key: 'transport', label: 'Transport' },
            { key: 'zakwaterowanie', label: 'Zakwaterowanie' }
        ];
        for (let i = 1; i <= attractionsCount; i++) {
            steps.push({ key: `atrakcja${i}`, label: `Atrakcja ${i}` });
        }
        steps.push({ key: 'powrot', label: 'Powrot' });
        let currentStep = parseInt(sessionStorage.getItem('wyjazd_step') || '0', 10);
        const stepContainer = document.getElementById('stepContainer');
        function renderStep() {
            if (errorMsg) {
                stepContainer.innerHTML = '<div style="color:#b30000;font-size:20px;font-weight:bold;text-align:center;">' + errorMsg + '</div>';
                return;
            }
            stepContainer.innerHTML = '';
            const step = steps[currentStep];
            const label = document.createElement('div');
            label.className = 'step-label';
            label.textContent = step.label;
            // Pole na nazwƒô
            const input = document.createElement('input');
            input.className = 'text-input';
            input.id = 'stepInput';
            input.placeholder = step.label;
            input.value = sessionStorage.getItem(`wyjazd_${code}_${step.key}`) || '';
            stepContainer.appendChild(label);
            stepContainer.appendChild(input);
            // Pole kosztu tylko je≈õli nie miejscowosc
            let costInput = null;
            if (step.key !== 'miejscowosc') {
                const costLabel = document.createElement('div');
                costLabel.className = 'step-label';
                costLabel.textContent = 'Koszt';
                costInput = document.createElement('input');
                costInput.className = 'text-input';
                costInput.id = 'costInput';
                costInput.type = 'number';
                costInput.min = '0';
                costInput.step = '0.01';
                costInput.placeholder = 'Koszt';
                costInput.value = sessionStorage.getItem(`wyjazd_${code}_${step.key}_koszt`) || '';
                stepContainer.appendChild(costLabel);
                stepContainer.appendChild(costInput);
            }
            // Pole na opis
            const descLabel = document.createElement('div');
            descLabel.className = 'step-label';
            descLabel.textContent = 'Opis';
            const desc = document.createElement('textarea');
            desc.className = 'text-input';
            desc.style.resize = 'none';
            desc.style.minHeight = '40px';
            desc.style.maxHeight = '300px';
            desc.maxLength = 500;
            desc.id = 'descInput';
            desc.placeholder = 'Dodaj opis...';
            desc.value = sessionStorage.getItem(`wyjazd_${code}_${step.key}_desc`) || '';
            // Licznik znak√≥w
            const counter = document.createElement('div');
            counter.style.fontSize = '14px';
            counter.style.color = '#5a2a0e';
            counter.style.alignSelf = 'flex-end';
            counter.textContent = `${desc.value.length}/500 znak√≥w`;
            desc.addEventListener('input', function() {
                desc.style.height = 'auto';
                desc.style.height = (desc.scrollHeight) + 'px';
                counter.textContent = `${desc.value.length}/500 znak√≥w`;
            });
            // Ustaw poczƒÖtkowƒÖ wysoko≈õƒá
            setTimeout(() => {
                desc.style.height = 'auto';
                desc.style.height = (desc.scrollHeight) + 'px';
            }, 0);
            stepContainer.appendChild(descLabel);
            stepContainer.appendChild(desc);
            stepContainer.appendChild(counter);
            // Pokaz aktualna kwote
            const budgetInfo = document.createElement('div');
            budgetInfo.className = 'step-label';
            budgetInfo.textContent = 'Pozostala kwota: ' + budget.toFixed(2);
            stepContainer.appendChild(budgetInfo);
            const btn = document.createElement('button');
            btn.className = 'button';
            btn.textContent = currentStep < steps.length - 1 ? 'Dalej' : 'Zakoncz';
            btn.onclick = function() {
                const val = input.value.trim();
                const descVal = desc.value.trim();
                let costVal = '';
                let cost = 0;
                if (step.key !== 'miejscowosc') {
                    costVal = costInput.value.trim();
                    cost = parseFloat(costVal);
                    if (!val || costVal === '') {
                        alert('Wypelnij pole i koszt!');
                        return;
                    }
                    if (isNaN(cost) || cost < 0) {
                        alert('Koszt musi byc liczba nieujemna!');
                        return;
                    }
                    if (budget - cost < 0) {
                        alert('Brak wystarczajacej kwoty!');
                        return;
                    }
                } else {
                    if (!val) {
                        alert('Wypelnij pole!');
                        return;
                    }
                }
                if (descVal.length > 500) {
                    alert('Opis nie mo≈ºe przekraczaƒá 500 znak√≥w!');
                    return;
                }
                sessionStorage.setItem(`wyjazd_${code}_${step.key}`, val);
                if (step.key === 'miejscowosc') {
                    sessionStorage.setItem('lastCity', val);
                }
                sessionStorage.setItem(`wyjazd_${code}_${step.key}_desc`, descVal);
                if (step.key !== 'miejscowosc') {
                    sessionStorage.setItem(`wyjazd_${code}_${step.key}_koszt`, cost.toFixed(2));
                    budget -= cost;
                    sessionStorage.setItem('lobbyBudget', budget.toFixed(2));
                }
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    sessionStorage.setItem('wyjazd_step', currentStep);
                    renderStep();
                } else {
                    sessionStorage.removeItem('wyjazd_step');
                    window.location.href = 'podsumowanie.html';
                }
            };
            stepContainer.appendChild(btn);

            // Automatyczna aktualizacja panelu bocznego z miejscowo≈õciƒÖ
            let citySpan = document.getElementById('sidebarCity');
            let city = sessionStorage.getItem(`wyjazd_${code}_miejscowosc`) || sessionStorage.getItem('lastCity') || '';
            citySpan.textContent = city;
            // Wy≈õwietl kategorie dla aktualnego kroku
            renderCategories(step.key);
        }
        // Kategorie do wyszukiwarki
        const categories = {
            miejscowosc: ["Zwiedzanie", "Parki", "Duze Miasto", "Morze", "Relaks", "Sport", "G√≥ry", "Wie≈õ"],
            transport: ["Samoch√≥d", "PociƒÖg", "Autobus", "Rower", "Samolot", "Prom", "Metro", "Taxi"],
            zakwaterowanie: ["Hotel", "Hostel", "Apartament", "Kemping", "Agroturystyka", "Pensjonat", "Motel"],
            atrakcja: ["Muzeum", "Park rozrywki", "Pla≈ºa", "Szlak", "Restauracja", "Zamek", "Galeria", "Aquapark", "Klub"]
        };

        // Przyk≈Çadowe najpopularniejsze wyniki dla ka≈ºdej kategorii
        const popularResults = {
            miejscowosc: ["Warszawa", "Krak√≥w", "Gda≈Ñsk", "Zakopane", "Wroc≈Çaw"],
            transport: ["PKP Intercity", "FlixBus", "BlaBlaCar", "PolskiBus", "Uber"],
            zakwaterowanie: ["Hotel Marriott", "Hostel One", "Airbnb Apartament", "Camping S≈Çoneczny", "Pensjonat Pod Dƒôbem"],
            atrakcja: ["Muzeum Narodowe", "Energylandia", "Pla≈ºa Jelitkowo", "Szlak Orlich Gniazd", "Restauracja U Fukiera"]
        };

        function renderCategories(stepKey) {
            const catDiv = document.getElementById('categoriesList');
            if (!catDiv) return;
            catDiv.innerHTML = '';
            let catArr = [];
            if (stepKey.startsWith('atrakcja')) {
                catArr = categories.atrakcja;
            } else if (categories[stepKey]) {
                catArr = categories[stepKey];
            }
            catArr.forEach(cat => {
                const el = document.createElement('div');
                el.className = 'category-box';
                el.textContent = cat;
                catDiv.appendChild(el);
            });
        }

        function renderSearchResults(stepKey) {
            const resultsDiv = document.getElementById('searchResults');
            if (!resultsDiv) return;
            resultsDiv.innerHTML = '';
            let arr = [];
            if (stepKey.startsWith('atrakcja')) {
                arr = popularResults.atrakcja;
            } else if (popularResults[stepKey]) {
                arr = popularResults[stepKey];
            }
            arr.forEach(res => {
                const el = document.createElement('div');
                el.className = 'search-result-box';
                el.textContent = res;
                resultsDiv.appendChild(el);
            });
        }

        // Wywo≈Çuj renderSearchResults przy zmianie kroku i na starcie
        const origRenderCategories = renderCategories;
        renderCategories = function(stepKey) {
            origRenderCategories(stepKey);
            renderSearchResults(stepKey);
        };
        // Inicjalizacja na starcie
        (function() {
            const catDiv = document.getElementById('categoriesList');
            if (!catDiv) return;
            let wyjazdStep = parseInt(sessionStorage.getItem('wyjazd_step') || '0', 10);
            let stepKey = steps[wyjazdStep] ? steps[wyjazdStep].key : 'miejscowosc';
            renderCategories(stepKey);
        })();

        renderStep();
    // Sidebar wyszukiwania
    (function() {
        const sidebar = document.getElementById('searchSidebar');
        const toggle = document.getElementById('sidebarToggle');
        const countrySpan = document.getElementById('sidebarCountry');
        // Dodaj pole na miejscowo≈õƒá
        let citySpan = document.getElementById('sidebarCity');
        if (!citySpan) {
            citySpan = document.createElement('span');
            citySpan.className = 'sidebar-city';
            countrySpan.parentNode.appendChild(citySpan);
        }
        // Pobierz kraj z sessionStorage lub lobby
        let lobby = null;
        try { lobby = JSON.parse(sessionStorage.getItem('currentLobby')); } catch {}
    let country = lobby ? lobby.country : sessionStorage.getItem('lobbyCountry') || '';
    let code = lobby ? lobby.code : sessionStorage.getItem('lobbyCode') || '';
    let city = sessionStorage.getItem(`wyjazd_${code}_miejscowosc`) || sessionStorage.getItem('lastCity') || '';
    countrySpan.textContent = country;
    citySpan.textContent = city ? ' | ' + city : '';
        // Otw√≥rz na start
        setTimeout(() => { sidebar.classList.add('open'); }, 300);
        // Prze≈ÇƒÖcznik
        toggle.onclick = function() {
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                toggle.innerHTML = '&lt;';
            } else {
                toggle.innerHTML = '&gt;';
            }
        };
    })();
    </script>
</body>
</html>