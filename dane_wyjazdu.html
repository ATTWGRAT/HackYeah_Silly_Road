<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Silly road - Dane wyjazdu</title>
    <style>
        body { margin: 0; height: 100vh; background: #f7c564; font-family: Arial, sans-serif; }
        .container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff3d1; border-radius: 12px; border: 2px solid #5a2a0e; box-shadow: 0 8px 18px rgba(0,0,0,0.12); padding: 32px 24px; display: flex; flex-direction: column; align-items: center; gap: 18px; }
        .text-input { padding: 12px 32px; font-size: 22px; color: #863e15; background: #f7c564; border-radius: 4px; border: 2px solid #5a2a0e; font-weight: bold; box-shadow: 0 6px 12px rgba(0,0,0,0.08); outline: none; width: 220px; text-align: center; }
        .button { padding: 12px 32px; font-size: 22px; color: #f2cf0d; background: #863e15; border-radius: 4px; border: 2px solid #5a2a0e; font-weight: bold; box-shadow: 0 8px 18px rgba(0,0,0,0.12); cursor: pointer; }
        .button:hover { background: #5a2a0e; }
        .step-label { font-size: 22px; color: #5a2a0e; font-weight: bold; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="container" id="stepContainer">
        <!-- Dynamiczne pola krok po kroku -->
    </div>
    <script>
        let lobby = null;
        try {
            lobby = JSON.parse(sessionStorage.getItem('currentLobby'));
        } catch {}
        let code = lobby ? lobby.code : '';
        // Wylicz liczbę dni na podstawie beginning i end
        let beginning = lobby ? lobby.beginning : sessionStorage.getItem('lobbyBeginning');
        let end = lobby ? lobby.end : sessionStorage.getItem('lobbyEnd');
        let length = 2;
        let errorMsg = '';
        if (!beginning || !end) {
            errorMsg = 'Brak danych o dacie wyjazdu. Wróć do tworzenia lobby.';
        } else {
            const beginDate = new Date(beginning);
            const endDate = new Date(end);
            const diff = Math.floor((endDate - beginDate) / (1000 * 60 * 60 * 24));
            if (isNaN(diff) || diff < 1) {
                errorMsg = 'Daty wyjazdu są nieprawidłowe. Wróć do tworzenia lobby.';
            } else {
                length = diff + 1;
            }
        }
        sessionStorage.setItem('lobbyLength', length);
        let budget = parseFloat(lobby ? lobby.budget : sessionStorage.getItem('lobbyBudget'));
        if (isNaN(budget)) budget = 0;
        const attractionsCount = 2 + (length - 2) * 3;
        const steps = [
            { key: 'dojazd', label: 'Dojazd' },
            { key: 'zakwaterowanie', label: 'Zakwaterowanie' }
        ];
        for (let i = 1; i <= attractionsCount; i++) {
            steps.push({ key: `atrakcja${i}`, label: `Atrakcja ${i}` });
        }
        steps.push({ key: 'powrot', label: 'Powrot' });
        let currentStep = parseInt(sessionStorage.getItem('wyjazd_step') || '0', 10);
        const stepContainer = document.getElementById('stepContainer');
        function renderStep() {
            if (errorMsg) {
                stepContainer.innerHTML = '<div style="color:#b30000;font-size:20px;font-weight:bold;text-align:center;">' + errorMsg + '</div>';
                return;
            }
            stepContainer.innerHTML = '';
            const step = steps[currentStep];
            const label = document.createElement('div');
            label.className = 'step-label';
            label.textContent = step.label;
            // Pole na nazwę
            const input = document.createElement('input');
            input.className = 'text-input';
            input.id = 'stepInput';
            input.placeholder = step.label;
            input.value = sessionStorage.getItem(`wyjazd_${code}_${step.key}`) || '';
            stepContainer.appendChild(label);
            stepContainer.appendChild(input);
            // Pole kosztu
            const costLabel = document.createElement('div');
            costLabel.className = 'step-label';
            costLabel.textContent = 'Koszt';
            const costInput = document.createElement('input');
            costInput.className = 'text-input';
            costInput.id = 'costInput';
            costInput.type = 'number';
            costInput.min = '0';
            costInput.step = '0.01';
            costInput.placeholder = 'Koszt';
            costInput.value = sessionStorage.getItem(`wyjazd_${code}_${step.key}_koszt`) || '';
            stepContainer.appendChild(costLabel);
            stepContainer.appendChild(costInput);
            // Pole na opis
            const descLabel = document.createElement('div');
            descLabel.className = 'step-label';
            descLabel.textContent = 'Opis';
            const desc = document.createElement('textarea');
            desc.className = 'text-input';
            desc.style.resize = 'none';
            desc.style.minHeight = '40px';
            desc.style.maxHeight = '300px';
            desc.maxLength = 500;
            desc.id = 'descInput';
            desc.placeholder = 'Dodaj opis...';
            desc.value = sessionStorage.getItem(`wyjazd_${code}_${step.key}_desc`) || '';
            // Licznik znaków
            const counter = document.createElement('div');
            counter.style.fontSize = '14px';
            counter.style.color = '#5a2a0e';
            counter.style.alignSelf = 'flex-end';
            counter.textContent = `${desc.value.length}/500 znaków`;
            desc.addEventListener('input', function() {
                desc.style.height = 'auto';
                desc.style.height = (desc.scrollHeight) + 'px';
                counter.textContent = `${desc.value.length}/500 znaków`;
            });
            // Ustaw początkową wysokość
            setTimeout(() => {
                desc.style.height = 'auto';
                desc.style.height = (desc.scrollHeight) + 'px';
            }, 0);
            stepContainer.appendChild(descLabel);
            stepContainer.appendChild(desc);
            stepContainer.appendChild(counter);
            // Pokaz aktualna kwote
            const budgetInfo = document.createElement('div');
            budgetInfo.className = 'step-label';
            budgetInfo.textContent = 'Pozostala kwota: ' + budget.toFixed(2);
            stepContainer.appendChild(budgetInfo);
            const btn = document.createElement('button');
            btn.className = 'button';
            btn.textContent = currentStep < steps.length - 1 ? 'Dalej' : 'Zakoncz';
            btn.onclick = function() {
                const val = input.value.trim();
                const descVal = desc.value.trim();
                const costVal = costInput.value.trim();
                const cost = parseFloat(costVal);
                if (!val || costVal === '') {
                    alert('Wypelnij pole i koszt!');
                    return;
                }
                if (descVal.length > 500) {
                    alert('Opis nie może przekraczać 500 znaków!');
                    return;
                }
                if (isNaN(cost) || cost < 0) {
                    alert('Koszt musi byc liczba nieujemna!');
                    return;
                }
                if (budget - cost < 0) {
                    alert('Brak wystarczajacej kwoty!');
                    return;
                }
                sessionStorage.setItem(`wyjazd_${code}_${step.key}`, val);
                sessionStorage.setItem(`wyjazd_${code}_${step.key}_desc`, descVal);
                sessionStorage.setItem(`wyjazd_${code}_${step.key}_koszt`, cost.toFixed(2));
                budget -= cost;
                sessionStorage.setItem('lobbyBudget', budget.toFixed(2));
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    sessionStorage.setItem('wyjazd_step', currentStep);
                    renderStep();
                } else {
                    sessionStorage.removeItem('wyjazd_step');
                    window.location.href = 'podsumowanie.html';
                }
            };
            stepContainer.appendChild(btn);
        }
        renderStep();
    </script>
</body>
</html>